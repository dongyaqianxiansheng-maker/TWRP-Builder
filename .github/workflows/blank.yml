name: TWRP Build

on:
  workflow_dispatch:
    inputs:
      DEVICE_NAME:
        description: '设备名称（如: davinci）'
        required: true
        default: ''
      MANUFACTURER:
        description: '厂商名称（如: xiaomi）'
        required: true
        default: ''
      MANIFEST_BRANCH:
        description: 'manifest分支'
        required: true
        default: 'twrp-12.1'
      BUILD_TARGET:
        description: '构建目标（recoveryimage 或 bootimage）'
        required: true
        default: 'recoveryimage'
        type: choice
        options:
          - recoveryimage
          - bootimage
      BOOT_IMG_URL:
        description: 'boot.img下载链接（用于生成设备树）'
        required: true
        default: ''
      SYNC_METHOD:
        description: '同步方式'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - shallow

env:
  WORKSPACE: /home/runner/work/twrp-build/twrp-build

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        echo "=== 安装依赖包 ==="
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl \
        zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
        x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils \
        xsltproc unzip fontconfig libncurses5 libncurses5-dev openjdk-8-jdk
        
        # 安装Python 2
        sudo apt-get install -y python2
        
        # 建立软链接
        sudo ln -sf /usr/bin/python2 /usr/bin/python
        
        # 验证版本
        python --version
        
        # 设置Git用户信息
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        
        # 安装Python 3和pip
        sudo apt-get install -y python3 python3-pip
        
    - name: Setup repo tool
      run: |
        # 下载repo工具
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        
        # 添加到环境变量
        echo 'export PATH=~/bin:$PATH' >> ~/.bashrc
        echo 'export PATH=~/bin:$PATH' >> $GITHUB_ENV
        
    - name: Initialize and sync repo
      run: |
        # 创建工作目录
        mkdir -p ${{ env.WORKSPACE }}/twrp-aosp
        cd ${{ env.WORKSPACE }}/twrp-aosp
        
        # 初始化仓库
        if [ "${{ github.event.inputs.SYNC_METHOD }}" = "shallow" ]; then
          repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.MANIFEST_BRANCH }}
        else
          repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.MANIFEST_BRANCH }}
        fi
        
        # 开始同步
        repo sync -j$(nproc)
        
    - name: Download boot.img and generate device tree
      if: ${{ github.event.inputs.BOOT_IMG_URL != '' }}
      run: |
        cd ${{ env.WORKSPACE }}/twrp-aosp
        
        # 安装twrpdtgen
        pip3 install twrpdtgen
        
        # 创建设备目录
        mkdir -p device/${{ github.event.inputs.MANUFACTURER }}
        
        # 下载boot.img
        wget -O boot.img "${{ github.event.inputs.BOOT_IMG_URL }}"
        
        # 生成设备树
        python3 -m twrpdtgen -o device/${{ github.event.inputs.MANUFACTURER }}/${{ github.event.inputs.DEVICE_NAME }} boot.img
        
        # 清理临时文件
        rm -f boot.img
        
    - name: Setup device tree (if provided)
      if: ${{ github.event.inputs.BOOT_IMG_URL == '' }}
      run: |
        echo "如果没有提供boot.img链接，请确保设备树已预先放置在正确位置"
        echo "设备树路径应为: device/${{ github.event.inputs.MANUFACTURER }}/${{ github.event.inputs.DEVICE_NAME }}"
        
    - name: Build TWRP
      run: |
        cd ${{ env.WORKSPACE }}/twrp-aosp
        
        # 加载编译环境变量
        source build/envsetup.sh
        
        # 使用lunch命令指定设备
        lunch omni_${{ github.event.inputs.DEVICE_NAME }}-eng
        
        # 设置环境变量
        export ALLOW_MISSING_DEPENDENCIES=true
        
        # 开始编译
        if [ "${{ github.event.inputs.BUILD_TARGET }}" = "bootimage" ]; then
          mka bootimage
        else
          mka recoveryimage
        fi
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: twrp-build-${{ github.event.inputs.DEVICE_NAME }}
        path: |
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
        retention-days: 7
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' }}
      with:
        files: |
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*.zip
          ${{ env.WORKSPACE }}/twrp-aosp/out/target/product/${{ github.event.inputs.DEVICE_NAME }}/*vendor*.img
        name: ${{ github.event.inputs.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          Build ID: ${{ github.run_id }}
          Device: ${{ github.event.inputs.DEVICE_NAME }}
          Manufacturer: ${{ github.event.inputs.MANUFACTURER }}
          Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}
          Build Target: ${{ github.event.inputs.BUILD_TARGET }}
          Sync Method: ${{ github.event.inputs.SYNC_METHOD }}
          Generated from boot.img: ${{ github.event.inputs.BOOT_IMG_URL != '' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
