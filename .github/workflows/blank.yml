name: TWRP Build

on:
  workflow_dispatch:
    inputs:
      device_name:
        description: '设备名称 (如: davinci)'
        required: true
        type: string
      device_manufacturer:
        description: '设备制造商 (如: xiaomi)'
        required: true
        type: string
      boot_img_url:
        description: 'boot.img 下载链接'
        required: true
        type: string
      manifest_branch:
        description: 'TWRP manifest 分支'
        default: 'twrp-12.1'
        type: string
      build_target:
        description: '编译目标'
        default: 'bootimage'
        type: string

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        echo "=== 安装依赖包 ==="
        sudo apt-get update
        sudo apt-get install -y git-core gnupg flex bison build-essential zip curl \
        zlib1g-dev gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
        x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev libxml2-utils \
        xsltproc unzip fontconfig libncurses5 libncurses5-dev openjdk-11-jdk \
        python3-pip python-is-python3
        
        # Ubuntu 22.04 需要从 deadsnakes PPA 安装 Python 2
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa
        sudo apt-get update
        sudo apt-get install -y python2.7
        
        # 创建 Python 2 软链接
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        sudo ln -sf /usr/bin/python2 /usr/bin/python
        
        # 验证版本
        python --version
        java -version
    
    - name: Set up Git
      run: |
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
    
    - name: Install repo tool
      run: |
        mkdir -p ~/bin
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        # 直接导出 PATH 到当前 shell
        export PATH="$HOME/bin:$PATH"
        echo "PATH=$PATH" >> $GITHUB_ENV
        echo "Repo tool installed at: $(which repo || echo 'not found')"
    
    - name: Verify repo tool
      run: |
        echo "当前 PATH: $PATH"
        ls -la ~/bin/
        ~/bin/repo --version
    
    - name: Initialize repo and sync
      run: |
        echo "=== 初始化 TWRP 仓库 ==="
        mkdir -p twrp-aosp
        cd twrp-aosp
        ~/bin/repo init -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.manifest_branch }}
        ~/bin/repo sync -j$(nproc) --force-sync --no-clone-bundle --no-tags
    
    - name: Download boot.img
      run: |
        cd twrp-aosp
        mkdir -p boot_images
        curl -L "${{ github.event.inputs.boot_img_url }}" -o boot_images/boot.img
    
    - name: Install twrpdtgen and generate device tree
      run: |
        cd twrp-aosp
        pip3 install twrpdtgen
        
        # 生成设备树
        python3 -m twrpdtgen -o device/${{ github.event.inputs.device_manufacturer }}/${{ github.event.inputs.device_name }} boot_images/boot.img
        
        # 检查是否生成成功
        if [ -d "device/${{ github.event.inputs.device_manufacturer }}/${{ github.event.inputs.device_name }}" ]; then
          echo "设备树生成成功"
        else
          echo "设备树生成失败"
          exit 1
        fi
    
    - name: Setup build environment
      run: |
        cd twrp-aosp
        . build/envsetup.sh
        lunch omni_${{ github.event.inputs.device_name }}-eng
    
    - name: Build TWRP
      run: |
        cd twrp-aosp
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        mka ${{ github.event.inputs.build_target }}
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: twrp-build-${{ github.event.inputs.device_name }}
        path: |
          twrp-aosp/out/target/product/${{ github.event.inputs.device_name }}/*.img
          twrp-aosp/out/target/product/${{ github.event.inputs.device_name }}/*.zip
        retention-days: 7
    
    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v2
      with:
        files: |
          twrp-aosp/out/target/product/${{ github.event.inputs.device_name }}/*.img
          twrp-aosp/out/target/product/${{ github.event.inputs.device_name }}/*.zip
        name: ${{ github.event.inputs.device_name }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          Build ID: ${{ github.run_id }}
          Device: ${{ github.event.inputs.device_name }}
          Manufacturer: ${{ github.event.inputs.device_manufacturer }}
          Manifest Branch: ${{ github.event.inputs.manifest_branch }}
          Build Target: ${{ github.event.inputs.build_target }}
          Commit: ${{ github.sha }}
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
