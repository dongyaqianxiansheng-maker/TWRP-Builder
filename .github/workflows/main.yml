name: TWRP Build Enhanced

on:
  workflow_dispatch:
    inputs:
      # åŸºç¡€é…ç½®
      MANIFEST_URL:
        description: 'Manifestä»“åº“URL (æ”¯æŒHTTPSå’ŒSSH)'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp'
      MANIFEST_BRANCH:
        description: 'Manifeståˆ†æ”¯'
        required: true
        default: 'twrp-12.1'
      DEVICE_NAME:
        description: 'è®¾å¤‡åç§° (å¦‚: davinci)'
        required: true
        default: ''
      MAKEFILE_NAME:
        description: 'Makefileåç§° (å¦‚: omni_davinci)'
        required: true
        default: ''
      BUILD_TARGET:
        description: 'æ„å»ºç›®æ ‡'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot
      
      # è®¾å¤‡æ ‘é…ç½®
      DEVICE_TREE_SOURCE:
        description: 'è®¾å¤‡æ ‘æ¥æº'
        required: true
        default: 'external'
        type: choice
        options:
          - prebuilt
          - generate
          - external
      
      # å¤–éƒ¨è®¾å¤‡æ ‘é€‰é¡¹
      DEVICE_TREE_URL:
        description: 'è®¾å¤‡æ ‘ä»“åº“URL (å½“é€‰æ‹©externalæ—¶ä½¿ç”¨)'
        required: false
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'è®¾å¤‡æ ‘åˆ†æ”¯'
        required: false
        default: 'main'
      DEVICE_PATH:
        description: 'è®¾å¤‡æ ‘è·¯å¾„ (å¦‚: device/xiaomi/davinci)'
        required: false
        default: ''
      
      # è‡ªåŠ¨ç”Ÿæˆé€‰é¡¹
      BOOT_IMG_URL:
        description: 'boot.imgä¸‹è½½é“¾æ¥ (å½“é€‰æ‹©generateæ—¶ä½¿ç”¨)'
        required: false
        default: ''
      
      # å…¬å…±è®¾å¤‡æ ‘
      COMMON_TREE_URL:
        description: 'å…¬å…±è®¾å¤‡æ ‘URL (å¯é€‰)'
        required: false
      COMMON_PATH:
        description: 'å…¬å…±è®¾å¤‡æ ‘è·¯å¾„ (å¯é€‰)'
        required: false
      
      # é«˜çº§é€‰é¡¹
      SYNC_METHOD:
        description: 'åŒæ­¥æ–¹å¼'
        required: true
        default: 'shallow'
        type: choice
        options:
          - full
          - shallow
      SWAP_SIZE:
        description: 'äº¤æ¢ç©ºé—´å¤§å° (GB)'
        required: true
        default: '8'
      CREATE_RELEASE:
        description: 'æ˜¯å¦åˆ›å»ºRelease'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 180
    
    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::æ„å»ºå‚æ•°"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "Device Tree Source: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Sync Method: ${{ github.event.inputs.SYNC_METHOD }}"
        echo "Swap Size: ${{ github.event.inputs.SWAP_SIZE }} GB"
        echo "Create Release: ${{ github.event.inputs.CREATE_RELEASE }}"
        echo "::endgroup::"

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cleanup workspace
      uses: rokibhasansagar/slimhub_actions@main

    - name: Prepare build environment
      run: |
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt update
        
        # åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt install -y \
            bc \
            bison \
            build-essential \
            ccache \
            curl \
            flex \
            g++ \
            g++-multilib \
            gcc \
            gcc-multilib \
            git \
            git-lfs \
            gnupg \
            gperf \
            imagemagick \
            lib32ncurses-dev \
            lib32readline-dev \
            lib32z1-dev \
            libc6-dev-i386 \
            libgl1-mesa-dev \
            liblz4-tool \
            libncurses5-dev \
            libsdl1.2-dev \
            libssl-dev \
            libwxgtk3.2-dev \
            libxml2 \
            libxml2-utils \
            lzop \
            m4 \
            make \
            ncftp \
            pngcrush \
            python3 \
            python3-pip \
            rsync \
            schedtool \
            squashfs-tools \
            tree \
            unzip \
            wget \
            xsltproc \
            zip \
            zlib1g-dev
        
        # é…ç½®Gitä¼˜åŒ–
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions@github.com"
        git config --global core.compression 0
        git config --global http.postBuffer 1048576000
        git config --global https.postBuffer 1048576000

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup SSH Keys
      if: |
        startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || 
        startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com') ||
        startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com')
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo tool
      run: |
        echo "=== å®‰è£…repoå·¥å…· ==="
        sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        sudo chmod a+x /usr/local/bin/repo
        repo --version

    - name: Initialize repo with retry
      id: init_repo
      run: |
        echo "=== åˆå§‹åŒ–ä»“åº“ ==="
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        mkdir -p workspace
        cd workspace
        
        # è®¾ç½®repoé…ç½®
        export REPO_URL='https://gerrit.googlesource.com/git-repo'
        
        # å°è¯•åˆå§‹åŒ–ï¼Œæœ€å¤šé‡è¯•3æ¬¡
        for i in {1..3}; do
          echo "ç¬¬ $i æ¬¡å°è¯•åˆå§‹åŒ–ä»“åº“..."
          
          if [ "${{ github.event.inputs.SYNC_METHOD }}" = "shallow" ]; then
            repo init --depth=1 \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          else
            repo init \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          fi
          
          if [ $? -eq 0 ]; then
            echo "âœ… ä»“åº“åˆå§‹åŒ–æˆåŠŸ"
            break
          else
            echo "âŒ åˆå§‹åŒ–å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
            rm -rf .repo
          fi
        done
        
        # æ£€æŸ¥æ˜¯å¦åˆå§‹åŒ–æˆåŠŸ
        if [ ! -d ".repo" ]; then
          echo "âŒ ä»“åº“åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–manifest URL"
          exit 1
        fi
        
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT

    - name: Sync repo with timeout
      id: sync_repo
      timeout-minutes: 60
      run: |
        echo "=== åŒæ­¥ä»“åº“ä»£ç  ==="
        cd workspace
        
        # è®¾ç½®ç¯å¢ƒå˜é‡ä»¥ä¼˜åŒ–åŒæ­¥
        export REPO_SYNC_FLAGS="-j$(nproc --all) --no-clone-bundle --no-tags --force-sync"
        
        # å°è¯•åŒæ­¥ï¼Œæœ€å¤šé‡è¯•3æ¬¡
        for i in {1..3}; do
          echo "ç¬¬ $i æ¬¡å°è¯•åŒæ­¥ä»“åº“..."
          echo "å¼€å§‹æ—¶é—´: $(date)"
          
          # ä½¿ç”¨timeoutå‘½ä»¤é˜²æ­¢æ— é™ç­‰å¾…
          timeout 1800 repo sync $REPO_SYNC_FLAGS
          SYNC_EXIT_CODE=$?
          
          echo "ç»“æŸæ—¶é—´: $(date)"
          
          if [ $SYNC_EXIT_CODE -eq 0 ]; then
            echo "âœ… ä»“åº“åŒæ­¥æˆåŠŸ"
            break
          elif [ $SYNC_EXIT_CODE -eq 124 ]; then
            echo "âš ï¸ åŒæ­¥è¶…æ—¶ï¼Œæ¸…ç†åé‡è¯•..."
            # æ¸…ç†éƒ¨åˆ†ä¸‹è½½çš„å†…å®¹
            find .repo/project-objects -name "*.tmp" -delete 2>/dev/null || true
            find .repo/projects -name "*.lock" -delete 2>/dev/null || true
            sleep 10
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œé€€å‡ºç : $SYNC_EXIT_CODE"
            echo "ç­‰å¾…30ç§’åé‡è¯•..."
            sleep 30
          fi
        done
        
        # æ£€æŸ¥åŒæ­¥æ˜¯å¦æˆåŠŸ
        if [ ! -d "bootable/recovery" ]; then
          echo "âŒ ä»“åº“åŒæ­¥ä¸å®Œæ•´ï¼Œç¼ºå°‘å…³é”®ç›®å½•"
          echo "å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          exit 1
        fi
        
        echo "âœ… ä»“åº“åŒæ­¥å®Œæˆ"
        echo "åŒæ­¥åçš„ç›®å½•å¤§å°:"
        du -sh .

    - name: Handle prebuilt device tree
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'prebuilt' }}
      run: |
        echo "=== ä½¿ç”¨é¢„ç½®è®¾å¤‡æ ‘ ==="
        cd workspace
        
        # ä»è¾“å…¥è·å–è®¾å¤‡è·¯å¾„æˆ–è‡ªåŠ¨ç”Ÿæˆ
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # ä»è®¾å¤‡æ ‘URLæå–å‚å•†å’Œè®¾å¤‡å
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "æ— æ³•ä»URLæå–è®¾å¤‡è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®šDEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "è®¾å¤‡æ ‘è·¯å¾„: $DEVICE_PATH"
        
        # åˆ›å»ºè®¾å¤‡ç›®å½•
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # å¤åˆ¶é¢„ç½®è®¾å¤‡æ ‘
        if [ -d "../$DEVICE_PATH" ]; then
          echo "æ‰¾åˆ°é¢„ç½®è®¾å¤‡æ ‘ï¼Œå¤åˆ¶åˆ°æºç ç›®å½•"
          cp -r "../$DEVICE_PATH" "$DEVICE_PATH"
        else
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°é¢„ç½®è®¾å¤‡æ ‘"
          echo "è¯·ç¡®ä¿è®¾å¤‡æ ‘ä½äºï¼š$DEVICE_PATH"
          exit 1
        fi

    - name: Generate device tree from boot.img
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'generate' && github.event.inputs.BOOT_IMG_URL != '' }}
      run: |
        echo "=== ä»boot.imgç”Ÿæˆè®¾å¤‡æ ‘ ==="
        cd workspace
        
        # å®‰è£…twrpdtgen
        pip3 install twrpdtgen
        
        # ä»è¾“å…¥è·å–è®¾å¤‡è·¯å¾„æˆ–è‡ªåŠ¨ç”Ÿæˆ
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
          # æå–å‚å•†å’Œè®¾å¤‡å
          if [[ "$DEVICE_PATH" =~ device/([^/]+)/([^/]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
          fi
        else
          echo "ä½¿ç”¨generateæ¨¡å¼æ—¶å¿…é¡»æŒ‡å®šDEVICE_PATH"
          exit 1
        fi
        
        echo "è®¾å¤‡æ ‘è·¯å¾„: $DEVICE_PATH"
        
        # åˆ›å»ºè®¾å¤‡ç›®å½•
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # ä¸‹è½½boot.img
        echo "ä¸‹è½½boot.img..."
        wget --timeout=60 --tries=3 -O boot.img "${{ github.event.inputs.BOOT_IMG_URL }}"
        
        # ç”Ÿæˆè®¾å¤‡æ ‘
        echo "ç”Ÿæˆè®¾å¤‡æ ‘..."
        python3 -m twrpdtgen -o "$DEVICE_PATH" boot.img
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f boot.img

    - name: Clone external device tree
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'external' && github.event.inputs.DEVICE_TREE_URL != '' }}
      run: |
        echo "=== å…‹éš†å¤–éƒ¨è®¾å¤‡æ ‘ ==="
        cd workspace
        
        # ä»è¾“å…¥è·å–è®¾å¤‡è·¯å¾„æˆ–è‡ªåŠ¨ç”Ÿæˆ
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # ä»è®¾å¤‡æ ‘URLæå–å‚å•†å’Œè®¾å¤‡å
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "æ— æ³•ä»URLæå–è®¾å¤‡è·¯å¾„ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®šDEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "è®¾å¤‡æ ‘è·¯å¾„: $DEVICE_PATH"
        
        # åˆ›å»ºè®¾å¤‡ç›®å½•
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # å…‹éš†å¤–éƒ¨è®¾å¤‡æ ‘
        echo "å…‹éš†è®¾å¤‡æ ‘ä»“åº“..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.DEVICE_TREE_URL }}" \
          "$DEVICE_PATH"
        
        # æ£€æŸ¥æ˜¯å¦å…‹éš†æˆåŠŸ
        if [ -d "$DEVICE_PATH" ]; then
          echo "è®¾å¤‡æ ‘å…‹éš†æˆåŠŸ"
        else
          echo "é”™è¯¯ï¼šè®¾å¤‡æ ‘å…‹éš†å¤±è´¥"
          exit 1
        fi

    - name: Clone common tree
      if: |
        github.event.inputs.COMMON_TREE_URL != null
        && github.event.inputs.COMMON_PATH != null
        && github.event.inputs.COMMON_TREE_URL != ''
        && github.event.inputs.COMMON_PATH != ''
      run: |
        echo "=== å…‹éš†å…¬å…±è®¾å¤‡æ ‘ ==="
        cd workspace
        
        # åˆ›å»ºå…¬å…±è®¾å¤‡æ ‘ç›®å½•
        mkdir -p $(dirname "${{ github.event.inputs.COMMON_PATH }}")
        
        # å…‹éš†å…¬å…±è®¾å¤‡æ ‘
        echo "å…‹éš†å…¬å…±è®¾å¤‡æ ‘ä»“åº“..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.COMMON_TREE_URL }}" \
          "${{ github.event.inputs.COMMON_PATH }}"
        
        # æ£€æŸ¥æ˜¯å¦å…‹éš†æˆåŠŸ
        if [ -d "${{ github.event.inputs.COMMON_PATH }}" ]; then
          echo "å…¬å…±è®¾å¤‡æ ‘å…‹éš†æˆåŠŸ"
        else
          echo "é”™è¯¯ï¼šå…¬å…±è®¾å¤‡æ ‘å…‹éš†å¤±è´¥"
          exit 1
        fi

    - name: Validate device tree
      run: |
        echo "=== éªŒè¯è®¾å¤‡æ ‘ ==="
        cd workspace
        
        # ç¡®å®šè®¾å¤‡æ ‘è·¯å¾„
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        elif [ "${{ github.event.inputs.DEVICE_TREE_SOURCE }}" = "external" ] && [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
          MANUFACTURER="${BASH_REMATCH[1]}"
          DEVICE="${BASH_REMATCH[2]}"
          DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
        else
          echo "æ— æ³•ç¡®å®šè®¾å¤‡æ ‘è·¯å¾„"
          exit 1
        fi
        
        echo "è®¾å¤‡æ ‘è·¯å¾„: $DEVICE_PATH"
        
        if [ -d "$DEVICE_PATH" ]; then
          echo "è®¾å¤‡æ ‘å­˜åœ¨"
          echo "è®¾å¤‡æ ‘å†…å®¹:"
          ls -la "$DEVICE_PATH/"
          
          # æ£€æŸ¥å¿…è¦çš„æ–‡ä»¶
          if [ -f "$DEVICE_PATH/AndroidProducts.mk" ] || [ -f "$DEVICE_PATH/device.mk" ] || [ -f "$DEVICE_PATH/BoardConfig.mk" ]; then
            echo "âœ… è®¾å¤‡æ ‘æ–‡ä»¶ç»“æ„æ­£å¸¸"
          else
            echo "âš ï¸ è­¦å‘Šï¼šè®¾å¤‡æ ‘å¯èƒ½ç¼ºå°‘å¿…è¦çš„é…ç½®æ–‡ä»¶"
            echo "æ‰¾åˆ°çš„æ–‡ä»¶:"
            find "$DEVICE_PATH" -name "*.mk" -o -name "*.sh" | head -20
          fi
        else
          echo "âŒ é”™è¯¯ï¼šè®¾å¤‡æ ‘ä¸å­˜åœ¨"
          echo "è¯·æ£€æŸ¥è®¾å¤‡æ ‘è·¯å¾„ï¼š$DEVICE_PATH"
          exit 1
        fi

    - name: Set Swap Space
    
     run: |
        echo "=== è®¾ç½®äº¤æ¢ç©ºé—´ ==="
        SWAP_SIZE=${{ github.event.inputs.SWAP_SIZE }}
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰äº¤æ¢ç©ºé—´
        if [ -f /swapfile ]; then
          echo "äº¤æ¢ç©ºé—´å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»º"
        else
          echo "åˆ›å»º ${SWAP_SIZE}GB äº¤æ¢ç©ºé—´..."
          sudo fallocate -l ${SWAP_SIZE}G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # éªŒè¯äº¤æ¢ç©ºé—´
          echo "äº¤æ¢ç©ºé—´çŠ¶æ€:"
          free -h
          swapon --show
        fi

    - name: Setup ccache
      run: |
        echo "=== é…ç½®ccache ==="
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_DIR=/tmp/ccache
        
        # åˆ›å»ºccacheç›®å½•
        mkdir -p $CCACHE_DIR
        
        # è®¾ç½®ccacheå¤§å°
        ccache -M 50G
        
        echo "ccacheé…ç½®å®Œæˆ"
        ccache -s

    - name: Prepare build configuration
      run: |
        echo "=== å‡†å¤‡ç¼–è¯‘é…ç½® ==="
        cd workspace
        
        # ç¡®å®šè®¾å¤‡åç§°
        if [ -n "${{ github.event.inputs.DEVICE_NAME }}" ]; then
          DEVICE_NAME="${{ github.event.inputs.DEVICE_NAME }}"
        else
          # ä»è®¾å¤‡è·¯å¾„æå–è®¾å¤‡å
          if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
            DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
            DEVICE_NAME=$(basename "$DEVICE_PATH")
          else
            echo "é”™è¯¯ï¼šæ— æ³•ç¡®å®šè®¾å¤‡åç§°"
            exit 1
          fi
        fi
        
        # ç¡®å®šMakefileåç§°
        if [ -n "${{ github.event.inputs.MAKEFILE_NAME }}" ]; then
          MAKEFILE_NAME="${{ github.event.inputs.MAKEFILE_NAME }}"
        else
          # è‡ªåŠ¨ç”ŸæˆMakefileåç§°
          if [[ "$DEVICE_NAME" =~ ^[a-zA-Z0-9_]+$ ]]; then
            MAKEFILE_NAME="omni_${DEVICE_NAME}"
          else
            echo "é”™è¯¯ï¼šæ— æ³•è‡ªåŠ¨ç”ŸæˆMakefileåç§°ï¼Œè¯·æ‰‹åŠ¨æŒ‡å®š"
            exit 1
          fi
        fi
        
        echo "è®¾å¤‡åç§°: $DEVICE_NAME"
        echo "Makefileåç§°: $MAKEFILE_NAME"
        echo "æ„å»ºç›®æ ‡: ${{ github.event.inputs.BUILD_TARGET }}"
        
        # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡
        echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        echo "MAKEFILE_NAME=$MAKEFILE_NAME" >> $GITHUB_ENV

    - name: Start compilation
      timeout-minutes: 120
      run: |
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        cd workspace
        
        # å›åˆ°æºç æ ¹ç›®å½•
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        # åŠ è½½ç¼–è¯‘ç¯å¢ƒå˜é‡
        echo "åŠ è½½ç¼–è¯‘ç¯å¢ƒ..."
        source build/envsetup.sh
        
        # ä½¿ç”¨lunchå‘½ä»¤æŒ‡å®šè®¾å¤‡
        echo "é€‰æ‹©è®¾å¤‡: ${{ env.MAKEFILE_NAME }}-eng"
        lunch ${{ env.MAKEFILE_NAME }}-eng
        
        # è®¾ç½®ç¼–è¯‘ç¯å¢ƒ
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        
        # æ ¹æ®æ„å»ºç›®æ ‡é€‰æ‹©ç¼–è¯‘å‘½ä»¤
        BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}"
        echo "æ„å»ºç›®æ ‡: $BUILD_TARGET"
        
        if [ "$BUILD_TARGET" = "recovery" ]; then
          echo "ç¼–è¯‘recoveryé•œåƒ..."
          mka recoveryimage
        elif [ "$BUILD_TARGET" = "boot" ]; then
          echo "ç¼–è¯‘booté•œåƒ..."
          mka bootimage
        else
          echo "é”™è¯¯ï¼šæœªçŸ¥çš„æ„å»ºç›®æ ‡: $BUILD_TARGET"
          exit 1
        fi
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        if [ $? -eq 0 ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸ"
        else
          echo "âŒ ç¼–è¯‘å¤±è´¥"
          exit 1
        fi

    - name: List build artifacts
      run: |
        echo "=== åˆ—å‡ºç¼–è¯‘äº§ç‰© ==="
        cd workspace
        
        OUTPUT_DIR="out/target/product/${{ env.DEVICE_NAME }}"
        
        if [ -d "$OUTPUT_DIR" ]; then
          echo "è¾“å‡ºç›®å½•: $OUTPUT_DIR"
          echo "æ–‡ä»¶åˆ—è¡¨:"
          ls -la "$OUTPUT_DIR/"
          
          # æŸ¥æ‰¾ç‰¹å®šæ–‡ä»¶
          echo "æŸ¥æ‰¾é•œåƒæ–‡ä»¶:"
          find "$OUTPUT_DIR" -name "*.img" -o -name "*.zip" | sort
          
          # æ£€æŸ¥ä¸»è¦è¾“å‡ºæ–‡ä»¶
          BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}"
          TARGET_FILE="$OUTPUT_DIR/$BUILD_TARGET.img"
          
          if [ -f "$TARGET_FILE" ]; then
            echo "âœ… æ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$TARGET_FILE" | cut -f1)"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°ç›®æ ‡æ–‡ä»¶: $TARGET_FILE"
            echo "å°è¯•æŸ¥æ‰¾å…¶ä»–æ–‡ä»¶..."
            find "$OUTPUT_DIR" -name "*.img" -exec du -h {} \;
          fi
        else
          echo "âŒ è¾“å‡ºç›®å½•ä¸å­˜åœ¨: $OUTPUT_DIR"
          exit 1
        fi

    - name: Create Release
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        files: |
          workspace/out/target/product/${{ env.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*vendor*.img
        name: ${{ env.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          # TWRP Build Results
          
          ## Build Information
          - **Manifest**: ${{ github.event.inputs.MANIFEST_BRANCH }}
          - **Device**: ${{ env.DEVICE_NAME }}
          - **Target**: ${{ github.event.inputs.BUILD_TARGET }}.img
          - **Build ID**: ${{ github.run_id }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Device Tree Source
          - **Source**: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}
          ${{ github.event.inputs.DEVICE_TREE_URL && format('**Device Tree URL**: {0}', github.event.inputs.DEVICE_TREE_URL) || '' }}
          
          ## Notes
          - This is an automated build from GitHub Actions
          - Flash at your own risk
          - Always backup your data before flashing
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      if: ${{ github.event.inputs.CREATE_RELEASE != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: twrp-${{ env.DEVICE_NAME }}-${{ github.run_number }}
        path: |
          workspace/out/target/product/${{ env.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*vendor*.img
        retention-days: 7

    - name: Cleanup
      if: always()
      run: |
        echo "=== æ¸…ç†å·¥ä½œç©ºé—´ ==="
        
        # å…³é—­äº¤æ¢ç©ºé—´
        if [ -f /swapfile ]; then
          echo "å…³é—­äº¤æ¢ç©ºé—´..."
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
        fi
        
        # æ˜¾ç¤ºccacheç»Ÿè®¡
        echo "ccacheç»Ÿè®¡:"
        ccache -s || true
        
        # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
        echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
        df -h
        
        echo "æ¸…ç†å®Œæˆ"

    - name: Build Summary
      if: always()
      run: |
        echo "=== æ„å»ºæ€»ç»“ ==="
        echo "è®¾å¤‡: ${{ env.DEVICE_NAME }}"
        echo "Makefile: ${{ env.MAKEFILE_NAME }}"
        echo "æ„å»ºç›®æ ‡: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "æ„å»ºID: ${{ github.run_id }}"
        echo "çŠ¶æ€: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸå®Œæˆ"
          if [ "${{ github.event.inputs.CREATE_RELEASE }}" = "true" ]; then
            echo "ğŸ“¦ Releaseå·²åˆ›å»º"
          else
            echo "ğŸ“¦ äº§ç‰©å·²ä¸Šä¼ åˆ°Artifacts"
          fi
        else
          echo "âŒ æ„å»ºå¤±è´¥"
          echo "è¯·æ£€æŸ¥æ—¥å¿—ä»¥è·å–è¯¦ç»†ä¿¡æ¯"
        fi
