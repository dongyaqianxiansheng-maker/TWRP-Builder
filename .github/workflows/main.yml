name: TWRP Recovery Build

on:
  workflow_dispatch:
    inputs:
      manufacturer:
        description: '设备制造商 (如: xiaomi, asus)'
        required: true
        default: 'asus'
      device:
        description: '设备型号 (如: I003D, davinci)'
        required: true
        default: 'I003D'
      device_tree_url:
        description: '设备树仓库URL'
        required: true
        default: 'https://github.com/TeamWin/android_device_asus_I003D'
      device_tree_branch:
        description: '设备树分支'
        required: true
        default: 'android-12.1'
      manifest_branch:
        description: 'TWRP manifest分支'
        required: true
        default: 'twrp-12.1'
      build_target:
        description: '编译目标'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot

env:
  MANIFEST_URL: "https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git"
  WORKSPACE_DIR: "${{ github.workspace }}/twrp-build"
  DEVICE_PATH: "device/${{ inputs.manufacturer }}/${{ inputs.device }}"

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Display build parameters
      run: |
        echo "=== 构建参数 ==="
        echo "设备制造商: ${{ inputs.manufacturer }}"
        echo "设备型号: ${{ inputs.device }}"
        echo "设备树URL: ${{ inputs.device_tree_url }}"
        echo "设备树分支: ${{ inputs.device_tree_branch }}"
        echo "Manifest分支: ${{ inputs.manifest_branch }}"
        echo "编译目标: ${{ inputs.build_target }}"
        echo "工作目录: $WORKSPACE_DIR"
        echo "设备路径: $DEVICE_PATH"
        
    - name: Clean workspace
      run: |
        echo "=== 清理工作空间 ==="
        rm -rf "$WORKSPACE_DIR"
        mkdir -p "$WORKSPACE_DIR"
        
    - name: Install dependencies for Ubuntu 22.04
      run: |
        echo "=== 安装依赖包 (Ubuntu 22.04) ==="
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib libc6-dev-i386 lib32ncurses5-dev \
          x11proto-core-dev libx11-dev lib32z1-dev libgl1-mesa-dev \
          libxml2-utils xsltproc unzip fontconfig libncurses5 \
          libncurses5-dev libssl-dev liblz4-tool imagemagick ccache \
          bc lzop schedtool squashfs-tools pngcrush rsync python2 \
          python3 python3-pip tree libbz2-dev lzma ncftp \
          lib32readline-dev lib32z1-dev libsdl1.2-dev libgtk-3-dev \
          libglu1-mesa-dev freeglut3-dev qemu-user-static
        
        # Ubuntu 22.04 特定包名
        sudo apt-get install -y \
          libstdc++-10-dev \
          libncurses6 \
          libreadline8 \
          gcc-10-multilib \
          g++-10-multilib
        
        # 设置 Python 2 为默认
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 1
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 2
        sudo update-alternatives --set python /usr/bin/python2
        
        echo "Python 版本:"
        python --version
        
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'
        
    - name: Configure Git
      run: |
        echo "=== 配置 Git ==="
        git config --global user.email "github-actions@github.com"
        git config --global user.name "GitHub Actions"
        
    - name: Install repo tool
      run: |
        echo "=== 安装 repo 工具 ==="
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo
        
    - name: Initialize TWRP repository
      run: |
        echo "=== 初始化 TWRP 仓库 ==="
        cd "$WORKSPACE_DIR"
        
        # 使用浅克隆减少下载量
        repo init \
          --depth=1 \
          -u "$MANIFEST_URL" \
          -b "${{ inputs.manifest_branch }}" \
          --repo-rev=stable
        
        echo "初始化完成"
        
    - name: Clone device tree
      run: |
        echo "=== 克隆设备树 ==="
        cd "$WORKSPACE_DIR"
        
        # 先创建设备目录
        mkdir -p "$(dirname "$DEVICE_PATH")"
        
        # 克隆设备树
        git clone \
          --depth=1 \
          --branch "${{ inputs.device_tree_branch }}" \
          "${{ inputs.device_tree_url }}" \
          "$DEVICE_PATH"
        
        echo "设备树克隆完成"
        
    - name: Create local manifest for optimization
      run: |
        echo "=== 创建本地 manifest 优化同步 ==="
        cd "$WORKSPACE_DIR"
        
        mkdir -p .repo/local_manifests
        cat > .repo/local_manifests/local_manifest.xml << EOF
<?xml version="1.0" encoding="UTF-8"?>
<manifest>
  <!-- 移除不需要的大型项目以减少下载量 -->
  <remove-project name="platform/prebuilts/clang/host/linux-x86" />
  <remove-project name="platform/prebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9" />
  <remove-project name="platform/prebuilts/gcc/linux-x86/arm/arm-linux-androideabi-4.9" />
  <remove-project name="platform/prebuilts/gcc/linux-x86/x86/x86_64-linux-android-4.9" />
  <remove-project name="platform/prebuilts/android-emulator" />
  <remove-project name="platform/prebuilts/qemu-kernel" />
  
  <!-- 已经手动克隆的设备树 -->
  <project path="$DEVICE_PATH" 
           name="${{ inputs.device_tree_url }}"
           remote="github"
           revision="${{ inputs.device_tree_branch }}"
           clone-depth="1" />
</manifest>
EOF
        
        echo "本地 manifest 创建完成"
        
    - name: Sync repository with optimization
      run: |
        echo "=== 同步代码 (优化版) ==="
        cd "$WORKSPACE_DIR"
        
        # 优化同步参数，减少内存使用
        repo sync \
          -c \
          -j4 \
          --force-sync \
          --no-clone-bundle \
          --no-tags \
          --optimized-fetch \
          --prune
        
        echo "同步完成"
        echo "当前目录大小:"
        du -sh .
        
    - name: Setup swap space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 8
        
    - name: Setup build environment
      run: |
        echo "=== 设置编译环境 ==="
        cd "$WORKSPACE_DIR"
        
        # 加载环境变量
        source build/envsetup.sh
        
        # 确定 lunch 目标
        # 首先检查设备树中的 makefile
        if [ -f "$DEVICE_PATH/AndroidProducts.mk" ]; then
          # 尝试从 AndroidProducts.mk 读取
          PRODUCT_MAKEFILE=$(grep -o 'PRODUCT_MAKEFILE := [^ ]*' "$DEVICE_PATH/AndroidProducts.mk" | cut -d' ' -f3)
          if [ -n "$PRODUCT_MAKEFILE" ]; then
            PRODUCT_NAME=$(basename "$PRODUCT_MAKEFILE" .mk)
            LUNCH_TARGET="${PRODUCT_NAME}-eng"
          else
            # 回退到默认命名
            LUNCH_TARGET="twrp_${{ inputs.device }}-eng"
          fi
        elif [ -f "$DEVICE_PATH/omni_${{ inputs.device }}.mk" ]; then
          LUNCH_TARGET="omni_${{ inputs.device }}-eng"
        elif [ -f "$DEVICE_PATH/twrp_${{ inputs.device }}.mk" ]; then
          LUNCH_TARGET="twrp_${{ inputs.device }}-eng"
        else
          # 最终回退
          LUNCH_TARGET="twrp_${{ inputs.device }}-eng"
        fi
        
        echo "Lunch 目标: $LUNCH_TARGET"
        echo "LUNCH_TARGET=$LUNCH_TARGET" >> $GITHUB_ENV
        
        # 执行 lunch
        lunch "$LUNCH_TARGET"
        
    - name: Build recovery image
      run: |
        echo "=== 编译 ${{ inputs.build_target }} 镜像 ==="
        cd "$WORKSPACE_DIR"
        
        # 设置环境变量
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 10G
        
        # 清理之前的构建
        make clean
        
        # 开始编译
        make "${{ inputs.build_target }}image" -j$(nproc --all)
        
        echo "编译完成"
        
    - name: Verify build artifacts
      run: |
        echo "=== 验证构建产物 ==="
        OUTPUT_DIR="$WORKSPACE_DIR/out/target/product/${{ inputs.device }}"
        
        if [ -d "$OUTPUT_DIR" ]; then
          echo "输出目录: $OUTPUT_DIR"
          echo "找到的文件:"
          find "$OUTPUT_DIR" -name "*.img" -o -name "*.zip" -o -name "*.md5" | xargs ls -lh 2>/dev/null || true
          
          # 检查主要产物
          if [ -f "$OUTPUT_DIR/${{ inputs.build_target }}.img" ]; then
            echo "✅ 主要产物存在: $OUTPUT_DIR/${{ inputs.build_target }}.img"
            echo "文件大小: $(du -h "$OUTPUT_DIR/${{ inputs.build_target }}.img" | cut -f1)"
          else
            echo "❌ 主要产物不存在"
            # 尝试查找其他可能的产物
            echo "尝试查找其他产物..."
            find "$OUTPUT_DIR" -name "*.img" -type f | head -5
            exit 1
          fi
        else
          echo "❌ 输出目录不存在"
          exit 1
        fi
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.WORKSPACE_DIR }}/out/target/product/${{ inputs.device }}/${{ inputs.build_target }}.img
          ${{ env.WORKSPACE_DIR }}/out/target/product/${{ inputs.device }}/*.zip
          ${{ env.WORKSPACE_DIR }}/out/target/product/${{ inputs.device }}/*recovery*.img
          ${{ env.WORKSPACE_DIR }}/out/target/product/${{ inputs.device }}/*boot*.img
        name: ${{ inputs.device }}-TWRP-${{ github.run_number }}
        tag_name: build-${{ github.run_number }}
        body: |
          # TWRP Recovery Build
          
          ## 构建信息
          - **设备**: ${{ inputs.manufacturer }}/${{ inputs.device }}
          - **构建目标**: ${{ inputs.build_target }}
          - **构建编号**: ${{ github.run_number }}
          - **构建时间**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **设备树**: ${{ inputs.device_tree_url }}@${{ inputs.device_tree_branch }}
          - **Manifest**: ${{ env.MANIFEST_URL }}@${{ inputs.manifest_branch }}
          
          ## 使用说明
          1. 下载对应的镜像文件
          2. 使用 fastboot 刷入: `fastboot flash ${{ inputs.build_target }} <filename>.img`
          3. 重启到 recovery: `fastboot reboot recovery`
          
          ## 注意事项
          - 刷机有风险，请备份重要数据
          - 确保设备已解锁 bootloader
          - 仅适用于指定设备型号
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifacts as backup
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: twrp-build-artifacts-${{ inputs.device }}-${{ github.run_number }}
        path: |
          ${{ env.WORKSPACE_DIR }}/out/target/product/${{ inputs.device }}/
        retention-days: 7
        if-no-files-found: error
        
    - name: Cleanup workspace
      if: always()
      run: |
        echo "=== 清理工作空间 ==="
        echo "构建完成，清理中间文件..."
        # 显示最终磁盘使用情况
        echo "最终磁盘使用:"
        df -h
