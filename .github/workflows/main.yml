name: Build TWRP

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180  # 3小时超时
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: Set up environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential zip curl zlib1g-dev \
          gcc-multilib g++-multilib libc6-dev-i386 libncurses5 \
          lib32ncurses5-dev x11proto-core-dev libx11-dev lib32z1-dev \
          libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
          python3 python3-pip openjdk-11-jdk ccache
        
    - name: Set up ccache
      uses: actions/cache@v3
      with:
        path: ~/.ccache
        key: ${{ runner.os }}-ccache-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-ccache-
          
    - name: Configure build environment
      run: |
        export USE_CCACHE=1
        export CCACHE_COMPRESS=1
        export CCACHE_DIR=/home/runner/.ccache
        ccache -M 50G
        
        # 设置编译环境
        source build/envsetup.sh
        
        # 检查设备树是否存在
        if [ -d "device/asr/dove_evb4" ]; then
          echo "Building for dove_evb4"
          lunch twrp_dove_evb4-eng
        elif [ -d "device/sprd/dove_evb4" ]; then
          echo "Found device tree at device/sprd/dove_evb4"
          # 创建符号链接
          mkdir -p device/asr
          ln -sf ../../sprd/dove_evb4 device/asr/dove_evb4
          lunch twrp_dove_evb4-eng
        else
          echo "Device tree not found, building for generic arm"
          lunch aosp_arm-eng
        fi
        
    - name: Build recovery
      run: |
        # 设置低内存优化
        export JACK_SERVER_VM_ARGUMENTS="-Dfile.encoding=UTF-8 -XX:+TieredCompilation -Xmx4g"
        export ANDROID_JACK_VM_ARGS="-Xmx4g -Dfile.encoding=UTF-8 -XX:+TieredCompilation"
        
        # 编译 recovery
        mka -j$(nproc) recoveryimage
        
    - name: Upload recovery image
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-Recovery
        path: |
          out/target/product/*/recovery.img
          out/target/product/*/boot.img
        if-no-files-found: error
        retention-days: 7
        
    - name: Upload build logs
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Logs
        path: |
          out/error.log
          out/build.log
        if-no-files-found: ignore
