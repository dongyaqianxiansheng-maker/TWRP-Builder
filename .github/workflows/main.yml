name: TWRP Build Enhanced

on:
  workflow_dispatch:
    inputs:
      # 基础配置
      MANIFEST_URL:
        description: 'Manifest仓库URL (支持HTTPS和SSH)'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp'
      MANIFEST_BRANCH:
        description: 'Manifest分支'
        required: true
        default: 'twrp-12.1'
      DEVICE_NAME:
        description: '设备名称 (如: davinci)'
        required: true
        default: ''
      MAKEFILE_NAME:
        description: 'Makefile名称 (如: omni_davinci)'
        required: true
        default: ''
      BUILD_TARGET:
        description: '构建目标'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot
      
      # 设备树配置
      DEVICE_TREE_SOURCE:
        description: '设备树来源'
        required: true
        default: 'external'
        type: choice
        options:
          - prebuilt
          - generate
          - external
      
      # 外部设备树选项
      DEVICE_TREE_URL:
        description: '设备树仓库URL (当选择external时使用)'
        required: false
        default: ''
      DEVICE_TREE_BRANCH:
        description: '设备树分支'
        required: false
        default: 'main'
      DEVICE_PATH:
        description: '设备树路径 (如: device/xiaomi/davinci)'
        required: false
        default: ''
      
      # 自动生成选项
      BOOT_IMG_URL:
        description: 'boot.img下载链接 (当选择generate时使用)'
        required: false
        default: ''
      
      # 公共设备树
      COMMON_TREE_URL:
        description: '公共设备树URL (可选)'
        required: false
      COMMON_PATH:
        description: '公共设备树路径 (可选)'
        required: false
      
      # 高级选项
      SYNC_METHOD:
        description: '同步方式'
        required: true
        default: 'shallow'
        type: choice
        options:
          - full
          - shallow
      SWAP_SIZE:
        description: '交换空间大小 (GB)'
        required: true
        default: '8'
      CREATE_RELEASE:
        description: '是否创建Release'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 180
    
    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::构建参数"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "Device Tree Source: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Sync Method: ${{ github.event.inputs.SYNC_METHOD }}"
        echo "Swap Size: ${{ github.event.inputs.SWAP_SIZE }} GB"
        echo "Create Release: ${{ github.event.inputs.CREATE_RELEASE }}"
        echo "::endgroup::"

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cleanup workspace
      uses: rokibhasansagar/slimhub_actions@main

    - name: Prepare build environment
      run: |
        echo "=== 安装编译依赖 ==="
        sudo apt update && sudo apt upgrade -y
        
        # 基础编译工具
        sudo apt install -y \
            bc \
            bison \
            build-essential \
            ccache \
            curl \
            flex \
            g++ \
            g++-multilib \
            gcc \
            gcc-multilib \
            git \
            git-lfs \
            gnupg \
            gperf \
            imagemagick \
            lib32ncurses5-dev \
            lib32readline-dev \
            lib32z1-dev \
            libc6-dev-i386 \
            libgl1-mesa-dev \
            liblz4-tool \
            libncurses5-dev \
            libsdl1.2-dev \
            libssl-dev \
            libwxgtk3.2-dev \
            libxml2 \
            libxml2-utils \
            lzop \
            m4 \
            make \
            ncftp \
            pngcrush \
            python3 \
            python-is-python2 \
            rsync \
            schedtool \
            squashfs-tools \
            tree \
            unzip \
            wget \
            xsltproc \
            zip \
            zlib1g-dev
        
        # 安装Python2
        sudo apt install -y python2 python2-dev
        sudo ln -sf /usr/bin/python2 /usr/bin/python
        
        # 配置Git优化
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions@github.com"
        git config --global core.compression 0
        git config --global http.postBuffer 1048576000
        git config --global https.postBuffer 1048576000

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup SSH Keys
      if: |
        startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || 
        startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com') ||
        startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com')
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo tool
      run: |
        echo "=== 安装repo工具 ==="
        sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        sudo chmod a+x /usr/local/bin/repo
        repo --version

    - name: Initialize repo with retry
      id: init_repo
      run: |
        echo "=== 初始化仓库 ==="
        echo "当前目录: $(pwd)"
        
        # 创建工作目录
        mkdir -p workspace
        cd workspace
        
        # 设置repo配置
        export REPO_URL='https://gerrit.googlesource.com/git-repo'
        
        # 尝试初始化，最多重试3次
        for i in {1..3}; do
          echo "第 $i 次尝试初始化仓库..."
          
          if [ "${{ github.event.inputs.SYNC_METHOD }}" = "shallow" ]; then
            repo init --depth=1 \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          else
            repo init \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          fi
          
          if [ $? -eq 0 ]; then
            echo "✅ 仓库初始化成功"
            break
          else
            echo "❌ 初始化失败，等待10秒后重试..."
            sleep 10
            rm -rf .repo
          fi
        done
        
        # 检查是否初始化成功
        if [ ! -d ".repo" ]; then
          echo "❌ 仓库初始化失败，请检查网络连接或manifest URL"
          exit 1
        fi
        
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT

    - name: Sync repo with timeout
      id: sync_repo
      timeout-minutes: 60
      run: |
        echo "=== 同步仓库代码 ==="
        cd workspace
        
        # 设置环境变量以优化同步
        export REPO_SYNC_FLAGS="-j$(nproc --all) --no-clone-bundle --no-tags --force-sync"
        
        # 尝试同步，最多重试3次
        for i in {1..3}; do
          echo "第 $i 次尝试同步仓库..."
          echo "开始时间: $(date)"
          
          # 使用timeout命令防止无限等待
          timeout 1800 repo sync $REPO_SYNC_FLAGS
          SYNC_EXIT_CODE=$?
          
          echo "结束时间: $(date)"
          
          if [ $SYNC_EXIT_CODE -eq 0 ]; then
            echo "✅ 仓库同步成功"
            break
          elif [ $SYNC_EXIT_CODE -eq 124 ]; then
            echo "⚠️ 同步超时，清理后重试..."
            # 清理部分下载的内容
            find .repo/project-objects -name "*.tmp" -delete 2>/dev/null || true
            find .repo/projects -name "*.lock" -delete 2>/dev/null || true
            sleep 10
          else
            echo "❌ 同步失败，退出码: $SYNC_EXIT_CODE"
            echo "等待30秒后重试..."
            sleep 30
          fi
        done
        
        # 检查同步是否成功
        if [ ! -d "bootable/recovery" ]; then
          echo "❌ 仓库同步不完整，缺少关键目录"
          echo "当前目录结构:"
          ls -la
          exit 1
        fi
        
        echo "✅ 仓库同步完成"
        echo "同步后的目录大小:"
        du -sh .

    - name: Handle prebuilt device tree
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'prebuilt' }}
      run: |
        echo "=== 使用预置设备树 ==="
        cd workspace
        
        # 从输入获取设备路径或自动生成
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # 从设备树URL提取厂商和设备名
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "无法从URL提取设备路径，请手动指定DEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "设备树路径: $DEVICE_PATH"
        
        # 创建设备目录
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # 复制预置设备树
        if [ -d "../$DEVICE_PATH" ]; then
          echo "找到预置设备树，复制到源码目录"
          cp -r "../$DEVICE_PATH" "$DEVICE_PATH"
        else
          echo "错误：未找到预置设备树"
          echo "请确保设备树位于：$DEVICE_PATH"
          exit 1
        fi

    - name: Generate device tree from boot.img
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'generate' && github.event.inputs.BOOT_IMG_URL != '' }}
      run: |
        echo "=== 从boot.img生成设备树 ==="
        cd workspace
        
        # 安装twrpdtgen
        pip3 install twrpdtgen
        
        # 从输入获取设备路径或自动生成
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
          # 提取厂商和设备名
          if [[ "$DEVICE_PATH" =~ device/([^/]+)/([^/]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
          fi
        else
          echo "使用generate模式时必须指定DEVICE_PATH"
          exit 1
        fi
        
        echo "设备树路径: $DEVICE_PATH"
        
        # 创建设备目录
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # 下载boot.img
        echo "下载boot.img..."
        wget --timeout=60 --tries=3 -O boot.img "${{ github.event.inputs.BOOT_IMG_URL }}"
        
        # 生成设备树
        echo "生成设备树..."
        python3 -m twrpdtgen -o "$DEVICE_PATH" boot.img
        
        # 清理临时文件
        rm -f boot.img

    - name: Clone external device tree
      if: ${{ github.event.inputs.DEVICE_TREE_SOURCE == 'external' && github.event.inputs.DEVICE_TREE_URL != '' }}
      run: |
        echo "=== 克隆外部设备树 ==="
        cd workspace
        
        # 从输入获取设备路径或自动生成
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # 从设备树URL提取厂商和设备名
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "无法从URL提取设备路径，请手动指定DEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "设备树路径: $DEVICE_PATH"
        
        # 创建设备目录
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # 克隆外部设备树
        echo "克隆设备树仓库..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.DEVICE_TREE_URL }}" \
          "$DEVICE_PATH"
        
        # 检查是否克隆成功
        if [ -d "$DEVICE_PATH" ]; then
          echo "设备树克隆成功"
        else
          echo "错误：设备树克隆失败"
          exit 1
        fi

    - name: Clone common tree
      if: |
        github.event.inputs.COMMON_TREE_URL != null
        && github.event.inputs.COMMON_PATH != null
        && github.event.inputs.COMMON_TREE_URL != ''
        && github.event.inputs.COMMON_PATH != ''
      run: |
        echo "=== 克隆公共设备树 ==="
        cd workspace
        
        # 创建公共设备树目录
        mkdir -p $(dirname "${{ github.event.inputs.COMMON_PATH }}")
        
        # 克隆公共设备树
        echo "克隆公共设备树仓库..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.COMMON_TREE_URL }}" \
          "${{ github.event.inputs.COMMON_PATH }}"
        
        # 检查是否克隆成功
        if [ -d "${{ github.event.inputs.COMMON_PATH }}" ]; then
          echo "公共设备树克隆成功"
        else
          echo "错误：公共设备树克隆失败"
          exit 1
        fi

    - name: Validate device tree
      run: |
        echo "=== 验证设备树 ==="
        cd workspace
        
        # 确定设备树路径
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        elif [ "${{ github.event.inputs.DEVICE_TREE_SOURCE }}" = "external" ] && [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
          MANUFACTURER="${BASH_REMATCH[1]}"
          DEVICE="${BASH_REMATCH[2]}"
          DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
        else
          echo "无法确定设备树路径"
          exit 1
        fi
        
        echo "设备树路径: $DEVICE_PATH"
        
        if [ -d "$DEVICE_PATH" ]; then
          echo "设备树存在"
          echo "设备树内容:"
          ls -la "$DEVICE_PATH/"
          
          # 检查必要的文件
          if [ -f "$DEVICE_PATH/AndroidProducts.mk" ] || [ -f "$DEVICE_PATH/device.mk" ] || [ -f "$DEVICE_PATH/BoardConfig.mk" ]; then
            echo "✅ 设备树文件结构正常"
          else
            echo "⚠️ 警告：设备树可能缺少必要的配置文件"
            echo "找到的文件:"
            find "$DEVICE_PATH" -name "*.mk" -o -name "*.sh" | head -20
          fi
        else
          echo "❌ 错误
