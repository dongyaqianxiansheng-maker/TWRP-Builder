name: TWRP Build Enhanced

on:
  workflow_dispatch:
    inputs:
      # Âü∫Á°ÄÈÖçÁΩÆ
      MANIFEST_URL:
        description: 'Manifest‰ªìÂ∫ìURL (ÊîØÊåÅHTTPSÂíåSSH)'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp'
      MANIFEST_BRANCH:
        description: 'ManifestÂàÜÊîØ'
        required: true
        default: 'twrp-12.1'
      DEVICE_NAME:
        description: 'ËÆæÂ§áÂêçÁß∞ (Â¶Ç: davinci)'
        required: true
        default: ''
      MAKEFILE_NAME:
        description: 'MakefileÂêçÁß∞ (Â¶Ç: omni_davinci)'
        required: true
        default: ''
      BUILD_TARGET:
        description: 'ÊûÑÂª∫ÁõÆÊ†á'
        required: true
        default: 'recovery'
        type: choice
        options:
          - recovery
          - boot
      
      # ËÆæÂ§áÊ†ëÈÖçÁΩÆ
      DEVICE_TREE_SOURCE:
        description: 'ËÆæÂ§áÊ†ëÊù•Ê∫ê'
        required: true
        default: 'external'
        type: choice
        options:
          - prebuilt
          - generate
          - external
      
      # Â§ñÈÉ®ËÆæÂ§áÊ†ëÈÄâÈ°π
      DEVICE_TREE_URL:
        description: 'ËÆæÂ§áÊ†ë‰ªìÂ∫ìURL (ÂΩìÈÄâÊã©externalÊó∂‰ΩøÁî®)'
        required: false
        default: ''
      DEVICE_TREE_BRANCH:
        description: 'ËÆæÂ§áÊ†ëÂàÜÊîØ'
        required: false
        default: 'main'
      DEVICE_PATH:
        description: 'ËÆæÂ§áÊ†ëË∑ØÂæÑ (Â¶Ç: device/xiaomi/davinci)'
        required: false
        default: ''
      
      # Ëá™Âä®ÁîüÊàêÈÄâÈ°π
      BOOT_IMG_URL:
        description: 'boot.img‰∏ãËΩΩÈìæÊé• (ÂΩìÈÄâÊã©generateÊó∂‰ΩøÁî®)'
        required: false
        default: ''
      
      # ÂÖ¨ÂÖ±ËÆæÂ§áÊ†ë
      COMMON_TREE_URL:
        description: 'ÂÖ¨ÂÖ±ËÆæÂ§áÊ†ëURL (ÂèØÈÄâ)'
        required: false
        default: ''
      COMMON_PATH:
        description: 'ÂÖ¨ÂÖ±ËÆæÂ§áÊ†ëË∑ØÂæÑ (ÂèØÈÄâ)'
        required: false
        default: ''
      
      # È´òÁ∫ßÈÄâÈ°π
      SYNC_METHOD:
        description: 'ÂêåÊ≠•ÊñπÂºè'
        required: true
        default: 'shallow'
        type: choice
        options:
          - full
          - shallow
      SWAP_SIZE:
        description: '‰∫§Êç¢Á©∫Èó¥Â§ßÂ∞è (GB)'
        required: true
        default: '8'
      CREATE_RELEASE:
        description: 'ÊòØÂê¶ÂàõÂª∫Release'
        required: true
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  build:
    if: github.event.repository.owner.id == github.event.sender.id
    runs-on: ubuntu-24.04
    permissions:
      contents: write
    timeout-minutes: 180
    
    steps:
    - name: Display Run Parameters
      run: |
        echo "::group::ÊûÑÂª∫ÂèÇÊï∞"
        echo "Manifest URL: ${{ github.event.inputs.MANIFEST_URL }}"
        echo "Manifest Branch: ${{ github.event.inputs.MANIFEST_BRANCH }}"
        echo "Device Name: ${{ github.event.inputs.DEVICE_NAME }}"
        echo "Makefile Name: ${{ github.event.inputs.MAKEFILE_NAME }}"
        echo "Build Target: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "Device Tree Source: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}"
        echo "Device Tree URL: ${{ github.event.inputs.DEVICE_TREE_URL }}"
        echo "Device Tree Branch: ${{ github.event.inputs.DEVICE_TREE_BRANCH }}"
        echo "Device Path: ${{ github.event.inputs.DEVICE_PATH }}"
        echo "Sync Method: ${{ github.event.inputs.SYNC_METHOD }}"
        echo "Swap Size: ${{ github.event.inputs.SWAP_SIZE }} GB"
        echo "Create Release: ${{ github.event.inputs.CREATE_RELEASE }}"
        echo "::endgroup::"

    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Cleanup workspace
      uses: rokibhasansagar/slimhub_actions@main

    - name: Prepare build environment
      run: |
        echo "=== ÂÆâË£ÖÁºñËØë‰æùËµñ ==="
        sudo apt update
        
        # Âü∫Á°ÄÁºñËØëÂ∑•ÂÖ∑
        sudo apt install -y \
            bc \
            bison \
            build-essential \
            ccache \
            curl \
            flex \
            g++ \
            g++-multilib \
            gcc \
            gcc-multilib \
            git \
            git-lfs \
            gnupg \
            gperf \
            imagemagick \
            lib32ncurses-dev \
            lib32readline-dev \
            lib32z1-dev \
            libc6-dev-i386 \
            libgl1-mesa-dev \
            liblz4-tool \
            libncurses5-dev \
            libsdl1.2-dev \
            libssl-dev \
            libwxgtk3.2-dev \
            libxml2 \
            libxml2-utils \
            lzop \
            m4 \
            make \
            ncftp \
            pngcrush \
            python3 \
            python3-pip \
            rsync \
            schedtool \
            squashfs-tools \
            tree \
            unzip \
            wget \
            xsltproc \
            zip \
            zlib1g-dev
        
        # ÈÖçÁΩÆGit‰ºòÂåñ
        git config --global user.name "GitHub Actions"
        git config --global user.email "github-actions@github.com"
        git config --global core.compression 0
        git config --global http.postBuffer 1048576000
        git config --global https.postBuffer 1048576000

    - name: Install OpenJDK
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '11'

    - name: Setup SSH Keys
      if: |
        startsWith(github.event.inputs.MANIFEST_URL, 'git@github.com') || 
        (github.event.inputs.DEVICE_TREE_URL != '' && startsWith(github.event.inputs.DEVICE_TREE_URL, 'git@github.com')) ||
        (github.event.inputs.COMMON_TREE_URL != '' && startsWith(github.event.inputs.COMMON_TREE_URL, 'git@github.com'))
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: |
          ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Install repo tool
      run: |
        echo "=== ÂÆâË£ÖrepoÂ∑•ÂÖ∑ ==="
        sudo curl -o /usr/local/bin/repo https://storage.googleapis.com/git-repo-downloads/repo
        sudo chmod a+x /usr/local/bin/repo
        repo --version

    - name: Initialize repo with retry
      id: init_repo
      run: |
        echo "=== ÂàùÂßãÂåñ‰ªìÂ∫ì ==="
        echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
        
        # ÂàõÂª∫Â∑•‰ΩúÁõÆÂΩï
        mkdir -p workspace
        cd workspace
        
        # ËÆæÁΩÆrepoÈÖçÁΩÆ
        export REPO_URL='https://gerrit.googlesource.com/git-repo'
        
        # Â∞ùËØïÂàùÂßãÂåñÔºåÊúÄÂ§öÈáçËØï3Ê¨°
        for i in {1..3}; do
          echo "Á¨¨ $i Ê¨°Â∞ùËØïÂàùÂßãÂåñ‰ªìÂ∫ì..."
          
          if [ "${{ github.event.inputs.SYNC_METHOD }}" = "shallow" ]; then
            repo init --depth=1 \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          else
            repo init \
              -u "${{ github.event.inputs.MANIFEST_URL }}" \
              -b "${{ github.event.inputs.MANIFEST_BRANCH }}" \
              --repo-url=$REPO_URL
          fi
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂàùÂßãÂåñÊàêÂäü"
            break
          else
            echo "‚ùå ÂàùÂßãÂåñÂ§±Ë¥•ÔºåÁ≠âÂæÖ10ÁßíÂêéÈáçËØï..."
            sleep 10
            rm -rf .repo
          fi
        done
        
        # Ê£ÄÊü•ÊòØÂê¶ÂàùÂßãÂåñÊàêÂäü
        if [ ! -d ".repo" ]; then
          echo "‚ùå ‰ªìÂ∫ìÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•Êàñmanifest URL"
          exit 1
        fi
        
        echo "workspace-folder=$(pwd)" >> $GITHUB_OUTPUT

    - name: Sync repo with timeout
      id: sync_repo
      timeout-minutes: 60
      run: |
        echo "=== ÂêåÊ≠•‰ªìÂ∫ì‰ª£Á†Å ==="
        cd workspace
        
        # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè‰ª•‰ºòÂåñÂêåÊ≠•
        export REPO_SYNC_FLAGS="-j$(nproc --all) --no-clone-bundle --no-tags --force-sync"
        
        # Â∞ùËØïÂêåÊ≠•ÔºåÊúÄÂ§öÈáçËØï3Ê¨°
        for i in {1..3}; do
          echo "Á¨¨ $i Ê¨°Â∞ùËØïÂêåÊ≠•‰ªìÂ∫ì..."
          echo "ÂºÄÂßãÊó∂Èó¥: $(date)"
          
          # ‰ΩøÁî®timeoutÂëΩ‰ª§Èò≤Ê≠¢Êó†ÈôêÁ≠âÂæÖ
          timeout 1800 repo sync $REPO_SYNC_FLAGS
          SYNC_EXIT_CODE=$?
          
          echo "ÁªìÊùüÊó∂Èó¥: $(date)"
          
          if [ $SYNC_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ ‰ªìÂ∫ìÂêåÊ≠•ÊàêÂäü"
            break
          elif [ $SYNC_EXIT_CODE -eq 124 ]; then
            echo "‚ö†Ô∏è ÂêåÊ≠•Ë∂ÖÊó∂ÔºåÊ∏ÖÁêÜÂêéÈáçËØï..."
            # Ê∏ÖÁêÜÈÉ®ÂàÜ‰∏ãËΩΩÁöÑÂÜÖÂÆπ
            find .repo/project-objects -name "*.tmp" -delete 2>/dev/null || true
            find .repo/projects -name "*.lock" -delete 2>/dev/null || true
            sleep 10
          else
            echo "‚ùå ÂêåÊ≠•Â§±Ë¥•ÔºåÈÄÄÂá∫Á†Å: $SYNC_EXIT_CODE"
            echo "Á≠âÂæÖ30ÁßíÂêéÈáçËØï..."
            sleep 30
          fi
        done
        
        # Ê£ÄÊü•ÂêåÊ≠•ÊòØÂê¶ÊàêÂäü
        if [ ! -d "bootable/recovery" ]; then
          echo "‚ùå ‰ªìÂ∫ìÂêåÊ≠•‰∏çÂÆåÊï¥ÔºåÁº∫Â∞ëÂÖ≥ÈîÆÁõÆÂΩï"
          echo "ÂΩìÂâçÁõÆÂΩïÁªìÊûÑ:"
          ls -la
          exit 1
        fi
        
        echo "‚úÖ ‰ªìÂ∫ìÂêåÊ≠•ÂÆåÊàê"
        echo "ÂêåÊ≠•ÂêéÁöÑÁõÆÂΩïÂ§ßÂ∞è:"
        du -sh .

    - name: Handle prebuilt device tree
      if: github.event.inputs.DEVICE_TREE_SOURCE == 'prebuilt'
      run: |
        echo "=== ‰ΩøÁî®È¢ÑÁΩÆËÆæÂ§áÊ†ë ==="
        cd workspace
        
        # ‰ªéËæìÂÖ•Ëé∑ÂèñËÆæÂ§áË∑ØÂæÑÊàñËá™Âä®ÁîüÊàê
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # ‰ªéËÆæÂ§áÊ†ëURLÊèêÂèñÂéÇÂïÜÂíåËÆæÂ§áÂêç
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "Êó†Ê≥ï‰ªéURLÊèêÂèñËÆæÂ§áË∑ØÂæÑÔºåËØ∑ÊâãÂä®ÊåáÂÆöDEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "ËÆæÂ§áÊ†ëË∑ØÂæÑ: $DEVICE_PATH"
        
        # ÂàõÂª∫ËÆæÂ§áÁõÆÂΩï
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # Â§çÂà∂È¢ÑÁΩÆËÆæÂ§áÊ†ë
        if [ -d "../$DEVICE_PATH" ]; then
          echo "ÊâæÂà∞È¢ÑÁΩÆËÆæÂ§áÊ†ëÔºåÂ§çÂà∂Âà∞Ê∫êÁ†ÅÁõÆÂΩï"
          cp -r "../$DEVICE_PATH" "$DEVICE_PATH"
        else
          echo "ÈîôËØØÔºöÊú™ÊâæÂà∞È¢ÑÁΩÆËÆæÂ§áÊ†ë"
          echo "ËØ∑Á°Æ‰øùËÆæÂ§áÊ†ë‰Ωç‰∫éÔºö$DEVICE_PATH"
          exit 1
        fi

    - name: Generate device tree from boot.img
      if: github.event.inputs.DEVICE_TREE_SOURCE == 'generate' && github.event.inputs.BOOT_IMG_URL != ''
      run: |
        echo "=== ‰ªéboot.imgÁîüÊàêËÆæÂ§áÊ†ë ==="
        cd workspace
        
        # ÂÆâË£Ötwrpdtgen
        pip3 install twrpdtgen
        
        # ‰ªéËæìÂÖ•Ëé∑ÂèñËÆæÂ§áË∑ØÂæÑÊàñËá™Âä®ÁîüÊàê
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
          # ÊèêÂèñÂéÇÂïÜÂíåËÆæÂ§áÂêç
          if [[ "$DEVICE_PATH" =~ device/([^/]+)/([^/]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
          fi
        else
          echo "‰ΩøÁî®generateÊ®°ÂºèÊó∂ÂøÖÈ°ªÊåáÂÆöDEVICE_PATH"
          exit 1
        fi
        
        echo "ËÆæÂ§áÊ†ëË∑ØÂæÑ: $DEVICE_PATH"
        
        # ÂàõÂª∫ËÆæÂ§áÁõÆÂΩï
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # ‰∏ãËΩΩboot.img
        echo "‰∏ãËΩΩboot.img..."
        wget --timeout=60 --tries=3 -O boot.img "${{ github.event.inputs.BOOT_IMG_URL }}"
        
        # ÁîüÊàêËÆæÂ§áÊ†ë
        echo "ÁîüÊàêËÆæÂ§áÊ†ë..."
        python3 -m twrpdtgen -o "$DEVICE_PATH" boot.img
        
        # Ê∏ÖÁêÜ‰∏¥Êó∂Êñá‰ª∂
        rm -f boot.img

    - name: Clone external device tree
      if: github.event.inputs.DEVICE_TREE_SOURCE == 'external' && github.event.inputs.DEVICE_TREE_URL != ''
      run: |
        echo "=== ÂÖãÈöÜÂ§ñÈÉ®ËÆæÂ§áÊ†ë ==="
        cd workspace
        
        # ‰ªéËæìÂÖ•Ëé∑ÂèñËÆæÂ§áË∑ØÂæÑÊàñËá™Âä®ÁîüÊàê
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        else
          # ‰ªéËÆæÂ§áÊ†ëURLÊèêÂèñÂéÇÂïÜÂíåËÆæÂ§áÂêç
          if [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
            MANUFACTURER="${BASH_REMATCH[1]}"
            DEVICE="${BASH_REMATCH[2]}"
            DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
          else
            echo "Êó†Ê≥ï‰ªéURLÊèêÂèñËÆæÂ§áË∑ØÂæÑÔºåËØ∑ÊâãÂä®ÊåáÂÆöDEVICE_PATH"
            exit 1
          fi
        fi
        
        echo "ËÆæÂ§áÊ†ëË∑ØÂæÑ: $DEVICE_PATH"
        
        # ÂàõÂª∫ËÆæÂ§áÁõÆÂΩï
        mkdir -p $(dirname "$DEVICE_PATH")
        
        # ÂÖãÈöÜÂ§ñÈÉ®ËÆæÂ§áÊ†ë
        echo "ÂÖãÈöÜËÆæÂ§áÊ†ë‰ªìÂ∫ì..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.DEVICE_TREE_URL }}" \
          "$DEVICE_PATH"
        
        # Ê£ÄÊü•ÊòØÂê¶ÂÖãÈöÜÊàêÂäü
        if [ -d "$DEVICE_PATH" ]; then
          echo "ËÆæÂ§áÊ†ëÂÖãÈöÜÊàêÂäü"
        else
          echo "ÈîôËØØÔºöËÆæÂ§áÊ†ëÂÖãÈöÜÂ§±Ë¥•"
          exit 1
        fi

    - name: Clone common tree
      if: github.event.inputs.COMMON_TREE_URL != '' && github.event.inputs.COMMON_PATH != ''
      run: |
        echo "=== ÂÖãÈöÜÂÖ¨ÂÖ±ËÆæÂ§áÊ†ë ==="
        cd workspace
        
        # ÂàõÂª∫ÂÖ¨ÂÖ±ËÆæÂ§áÊ†ëÁõÆÂΩï
        mkdir -p $(dirname "${{ github.event.inputs.COMMON_PATH }}")
        
        # ÂÖãÈöÜÂÖ¨ÂÖ±ËÆæÂ§áÊ†ë
        echo "ÂÖãÈöÜÂÖ¨ÂÖ±ËÆæÂ§áÊ†ë‰ªìÂ∫ì..."
        git clone --depth=1 --single-branch \
          -b "${{ github.event.inputs.DEVICE_TREE_BRANCH }}" \
          "${{ github.event.inputs.COMMON_TREE_URL }}" \
          "${{ github.event.inputs.COMMON_PATH }}"
        
        # Ê£ÄÊü•ÊòØÂê¶ÂÖãÈöÜÊàêÂäü
        if [ -d "${{ github.event.inputs.COMMON_PATH }}" ]; then
          echo "ÂÖ¨ÂÖ±ËÆæÂ§áÊ†ëÂÖãÈöÜÊàêÂäü"
        else
          echo "ÈîôËØØÔºöÂÖ¨ÂÖ±ËÆæÂ§áÊ†ëÂÖãÈöÜÂ§±Ë¥•"
          exit 1
        fi

    - name: Validate device tree
      run: |
        echo "=== È™åËØÅËÆæÂ§áÊ†ë ==="
        cd workspace
        
        # Á°ÆÂÆöËÆæÂ§áÊ†ëË∑ØÂæÑ
        if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
          DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
        elif [ "${{ github.event.inputs.DEVICE_TREE_SOURCE }}" = "external" ] && [[ "${{ github.event.inputs.DEVICE_TREE_URL }}" =~ android_device_([^_]+)_([^_-]+) ]]; then
          MANUFACTURER="${BASH_REMATCH[1]}"
          DEVICE="${BASH_REMATCH[2]}"
          DEVICE_PATH="device/$MANUFACTURER/$DEVICE"
        else
          echo "Êó†Ê≥ïÁ°ÆÂÆöËÆæÂ§áÊ†ëË∑ØÂæÑ"
          exit 1
        fi
        
        echo "ËÆæÂ§áÊ†ëË∑ØÂæÑ: $DEVICE_PATH"
        
        if [ -d "$DEVICE_PATH" ]; then
          echo "ËÆæÂ§áÊ†ëÂ≠òÂú®"
          echo "ËÆæÂ§áÊ†ëÂÜÖÂÆπ:"
          ls -la "$DEVICE_PATH/"
          
          # Ê£ÄÊü•ÂøÖË¶ÅÁöÑÊñá‰ª∂
          if [ -f "$DEVICE_PATH/AndroidProducts.mk" ] || [ -f "$DEVICE_PATH/device.mk" ] || [ -f "$DEVICE_PATH/BoardConfig.mk" ]; then
            echo "‚úÖ ËÆæÂ§áÊ†ëÊñá‰ª∂ÁªìÊûÑÊ≠£Â∏∏"
          else
            echo "‚ö†Ô∏è Ë≠¶ÂëäÔºöËÆæÂ§áÊ†ëÂèØËÉΩÁº∫Â∞ëÂøÖË¶ÅÁöÑÈÖçÁΩÆÊñá‰ª∂"
            echo "ÊâæÂà∞ÁöÑÊñá‰ª∂:"
            find "$DEVICE_PATH" -name "*.mk" -o -name "*.sh" | head -20
          fi
        else
          echo "‚ùå ÈîôËØØÔºöËÆæÂ§áÊ†ë‰∏çÂ≠òÂú®"
          echo "ËØ∑Ê£ÄÊü•ËÆæÂ§áÊ†ëË∑ØÂæÑÔºö$DEVICE_PATH"
          exit 1
        fi

    - name: Set Swap Space
      run: |
      
        echo "=== ËÆæÁΩÆ‰∫§Êç¢Á©∫Èó¥ ==="
        SWAP_SIZE=${{ github.event.inputs.SWAP_SIZE }}
        
        # Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊúâ‰∫§Êç¢Á©∫Èó¥
        if [ -f /swapfile ]; then
          echo "‰∫§Êç¢Á©∫Èó¥Â∑≤Â≠òÂú®ÔºåË∑≥ËøáÂàõÂª∫"
        else
          echo "ÂàõÂª∫ ${SWAP_SIZE}GB ‰∫§Êç¢Á©∫Èó¥..."
          sudo fallocate -l ${SWAP_SIZE}G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          
          # È™åËØÅ‰∫§Êç¢Á©∫Èó¥
          echo "‰∫§Êç¢Á©∫Èó¥Áä∂ÊÄÅ:"
          free -h
          swapon --show
        fi

    - name: Setup ccache
      run: |
        echo "=== ÈÖçÁΩÆccache ==="
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        export CCACHE_DIR=/tmp/ccache
        
        # ÂàõÂª∫ccacheÁõÆÂΩï
        mkdir -p $CCACHE_DIR
        
        # ËÆæÁΩÆccacheÂ§ßÂ∞è
        ccache -M 50G
        
        echo "ccacheÈÖçÁΩÆÂÆåÊàê"
        ccache -s

    - name: Prepare build configuration
      run: |
        echo "=== ÂáÜÂ§áÁºñËØëÈÖçÁΩÆ ==="
        cd workspace
        
        # Á°ÆÂÆöËÆæÂ§áÂêçÁß∞
        if [ -n "${{ github.event.inputs.DEVICE_NAME }}" ]; then
          DEVICE_NAME="${{ github.event.inputs.DEVICE_NAME }}"
        else
          # ‰ªéËÆæÂ§áË∑ØÂæÑÊèêÂèñËÆæÂ§áÂêç
          if [ -n "${{ github.event.inputs.DEVICE_PATH }}" ]; then
            DEVICE_PATH="${{ github.event.inputs.DEVICE_PATH }}"
            DEVICE_NAME=$(basename "$DEVICE_PATH")
          else
            echo "ÈîôËØØÔºöÊó†Ê≥ïÁ°ÆÂÆöËÆæÂ§áÂêçÁß∞"
            exit 1
          fi
        fi
        
        # Á°ÆÂÆöMakefileÂêçÁß∞
        if [ -n "${{ github.event.inputs.MAKEFILE_NAME }}" ]; then
          MAKEFILE_NAME="${{ github.event.inputs.MAKEFILE_NAME }}"
        else
          # Ëá™Âä®ÁîüÊàêMakefileÂêçÁß∞
          if [[ "$DEVICE_NAME" =~ ^[a-zA-Z0-9_]+$ ]]; then
            MAKEFILE_NAME="omni_${DEVICE_NAME}"
          else
            echo "ÈîôËØØÔºöÊó†Ê≥ïËá™Âä®ÁîüÊàêMakefileÂêçÁß∞ÔºåËØ∑ÊâãÂä®ÊåáÂÆö"
            exit 1
          fi
        fi
        
        echo "ËÆæÂ§áÂêçÁß∞: $DEVICE_NAME"
        echo "MakefileÂêçÁß∞: $MAKEFILE_NAME"
        echo "ÊûÑÂª∫ÁõÆÊ†á: ${{ github.event.inputs.BUILD_TARGET }}"
        
        # ‰øùÂ≠òÂà∞ÁéØÂ¢ÉÂèòÈáè
        echo "DEVICE_NAME=$DEVICE_NAME" >> $GITHUB_ENV
        echo "MAKEFILE_NAME=$MAKEFILE_NAME" >> $GITHUB_ENV

    - name: Start compilation
      timeout-minutes: 120
      run: |
        echo "=== ÂºÄÂßãÁºñËØë ==="
        cd workspace
        
        # ÂõûÂà∞Ê∫êÁ†ÅÊ†πÁõÆÂΩï
        echo "ÂΩìÂâçÁõÆÂΩï: $(pwd)"
        
        # Âä†ËΩΩÁºñËØëÁéØÂ¢ÉÂèòÈáè
        echo "Âä†ËΩΩÁºñËØëÁéØÂ¢É..."
        source build/envsetup.sh
        
        # ‰ΩøÁî®lunchÂëΩ‰ª§ÊåáÂÆöËÆæÂ§á
        echo "ÈÄâÊã©ËÆæÂ§á: ${{ env.MAKEFILE_NAME }}-eng"
        lunch ${{ env.MAKEFILE_NAME }}-eng
        
        # ËÆæÁΩÆÁºñËØëÁéØÂ¢É
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL=C
        
        # Ê†πÊçÆÊûÑÂª∫ÁõÆÊ†áÈÄâÊã©ÁºñËØëÂëΩ‰ª§
        BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}"
        echo "ÊûÑÂª∫ÁõÆÊ†á: $BUILD_TARGET"
        
        if [ "$BUILD_TARGET" = "recovery" ]; then
          echo "ÁºñËØërecoveryÈïúÂÉè..."
          mka recoveryimage
        elif [ "$BUILD_TARGET" = "boot" ]; then
          echo "ÁºñËØëbootÈïúÂÉè..."
          mka bootimage
        else
          echo "ÈîôËØØÔºöÊú™Áü•ÁöÑÊûÑÂª∫ÁõÆÊ†á: $BUILD_TARGET"
          exit 1
        fi
        
        # Ê£ÄÊü•ÁºñËØëÁªìÊûú
        if [ $? -eq 0 ]; then
          echo "‚úÖ ÁºñËØëÊàêÂäü"
        else
          echo "‚ùå ÁºñËØëÂ§±Ë¥•"
          exit 1
        fi

    - name: List build artifacts
      run: |
        echo "=== ÂàóÂá∫ÁºñËØë‰∫ßÁâ© ==="
        cd workspace
        
        OUTPUT_DIR="out/target/product/${{ env.DEVICE_NAME }}"
        
        if [ -d "$OUTPUT_DIR" ]; then
          echo "ËæìÂá∫ÁõÆÂΩï: $OUTPUT_DIR"
          echo "Êñá‰ª∂ÂàóË°®:"
          ls -la "$OUTPUT_DIR/"
          
          # Êü•ÊâæÁâπÂÆöÊñá‰ª∂
          echo "Êü•ÊâæÈïúÂÉèÊñá‰ª∂:"
          find "$OUTPUT_DIR" -name "*.img" -o -name "*.zip" | sort
          
          # Ê£ÄÊü•‰∏ªË¶ÅËæìÂá∫Êñá‰ª∂
          BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}"
          TARGET_FILE="$OUTPUT_DIR/$BUILD_TARGET.img"
          
          if [ -f "$TARGET_FILE" ]; then
            echo "‚úÖ ÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂: $TARGET_FILE"
            echo "Êñá‰ª∂Â§ßÂ∞è: $(du -h "$TARGET_FILE" | cut -f1)"
          else
            echo "‚ö†Ô∏è Êú™ÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂: $TARGET_FILE"
            echo "Â∞ùËØïÊü•ÊâæÂÖ∂‰ªñÊñá‰ª∂..."
            find "$OUTPUT_DIR" -name "*.img" -exec du -h {} \;
          fi
        else
          echo "‚ùå ËæìÂá∫ÁõÆÂΩï‰∏çÂ≠òÂú®: $OUTPUT_DIR"
          exit 1
        fi

    - name: Create Release
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' }}
      uses: softprops/action-gh-release@v2
      with:
        files: |
          workspace/out/target/product/${{ env.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*vendor*.img
        name: ${{ env.DEVICE_NAME }}-${{ github.run_id }}
        tag_name: ${{ github.run_id }}
        body: |
          # TWRP Build Results
          
          ## Build Information
          - **Manifest**: ${{ github.event.inputs.MANIFEST_BRANCH }}
          - **Device**: ${{ env.DEVICE_NAME }}
          - **Target**: ${{ github.event.inputs.BUILD_TARGET }}.img
          - **Build ID**: ${{ github.run_id }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Device Tree Source
          - **Source**: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}
          ${{ github.event.inputs.DEVICE_TREE_URL && format('**Device Tree URL**: {0}', github.event.inputs.DEVICE_TREE_URL) || '' }}
          
          ## Notes
          - This is an automated build from GitHub Actions
          - Flash at your own risk
          - Always backup your data before flashing
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts
      if: ${{ github.event.inputs.CREATE_RELEASE != 'true' }}
      uses: actions/upload-artifact@v4
      with:
        name: twrp-${{ env.DEVICE_NAME }}-${{ github.run_number }}
        path: |
          workspace/out/target/product/${{ env.DEVICE_NAME }}/${{ github.event.inputs.BUILD_TARGET }}.img
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*.zip
          workspace/out/target/product/${{ env.DEVICE_NAME }}/*vendor*.img
        retention-days: 7

    - name: Cleanup
      if: always()
      run: |
        echo "=== Ê∏ÖÁêÜÂ∑•‰ΩúÁ©∫Èó¥ ==="
        
        # ÂÖ≥Èó≠‰∫§Êç¢Á©∫Èó¥
        if [ -f /swapfile ]; then
          echo "ÂÖ≥Èó≠‰∫§Êç¢Á©∫Èó¥..."
          sudo swapoff /swapfile || true
          sudo rm -f /swapfile || true
        fi
        
        # ÊòæÁ§∫ccacheÁªüËÆ°
        echo "ccacheÁªüËÆ°:"
        ccache -s || true
        
        # ÊòæÁ§∫Á£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ
        echo "Á£ÅÁõò‰ΩøÁî®ÊÉÖÂÜµ:"
        df -h
        
        echo "Ê∏ÖÁêÜÂÆåÊàê"

    - name: Build Summary
      if: always()
      run: |
        echo "=== ÊûÑÂª∫ÊÄªÁªì ==="
        echo "ËÆæÂ§á: ${{ env.DEVICE_NAME }}"
        echo "Makefile: ${{ env.MAKEFILE_NAME }}"
        echo "ÊûÑÂª∫ÁõÆÊ†á: ${{ github.event.inputs.BUILD_TARGET }}"
        echo "ÊûÑÂª∫ID: ${{ github.run_id }}"
        echo "Áä∂ÊÄÅ: ${{ job.status }}"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "‚úÖ ÊûÑÂª∫ÊàêÂäüÂÆåÊàê"
          if [ "${{ github.event.inputs.CREATE_RELEASE }}" = "true" ]; then
            echo "üì¶ ReleaseÂ∑≤ÂàõÂª∫"
          else
            echo "üì¶ ‰∫ßÁâ©Â∑≤‰∏ä‰º†Âà∞Artifacts"
          fi
        else
          echo "‚ùå ÊûÑÂª∫Â§±Ë¥•"
          echo "ËØ∑Ê£ÄÊü•Êó•Âøó‰ª•Ëé∑ÂèñËØ¶ÁªÜ‰ø°ÊÅØ"
        fi
    - name: Check build output
      run: |
        echo "=== Ê£ÄÊü•ÁºñËØëËæìÂá∫ ==="
        cd workspace
        
        echo "Êü•ÊâæÊâÄÊúâËæìÂá∫Êñá‰ª∂:"
        find out -name "*.img" -o -name "*.zip" -o -name "*.bin" 2>/dev/null | head -20
        
        echo "outÁõÆÂΩïÁªìÊûÑ:"
        find out -type d 2>/dev/null | head -30
        
        # Ê£ÄÊü•ÁºñËØëÊòØÂê¶ÁúüÁöÑÊàêÂäü
        if [ -d "out" ]; then
          echo "‚úÖ outÁõÆÂΩïÂ≠òÂú®"
          IMG_COUNT=$(find out -name "*.img" 2>/dev/null | wc -l)
          echo "ÊâæÂà∞ $IMG_COUNT ‰∏™.imgÊñá‰ª∂"
          
          if [ $IMG_COUNT -eq 0 ]; then
            echo "‚ö†Ô∏è Ë≠¶ÂëäÔºöÊú™ÊâæÂà∞‰ªª‰Ωï.imgÊñá‰ª∂ÔºåÁºñËØëÂèØËÉΩÊú™ÁîüÊàêÈ¢ÑÊúüËæìÂá∫"
            echo "Ê£ÄÊü•ÁºñËØëÊó•Âøó..."
            if [ -f "out/error.log" ]; then
              tail -50 out/error.log
            fi
          fi
        else
          echo "‚ùå outÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÁºñËØëÂèØËÉΩÂ§±Ë¥•"
          exit 1
        fi

    - name: List build artifacts
      run: |
        echo "=== ÂàóÂá∫ÁºñËØë‰∫ßÁâ© ==="
        cd workspace
        
        # È¶ñÂÖàÊü•ÊâæÊâÄÊúâÂèØËÉΩÁöÑËæìÂá∫ÁõÆÂΩï
        echo "Êü•ÊâæÊâÄÊúâËæìÂá∫ÁõÆÂΩï:"
        find out/target/product -type d -name "*dove*" 2>/dev/null || true
        find out/target/product -type d 2>/dev/null | head -20
        
        # Á°ÆÂÆöËÆæÂ§áÂêçÁß∞
        if [ -n "${{ env.DEVICE_NAME }}" ]; then
          DEVICE_NAME="${{ env.DEVICE_NAME }}"
        else
          DEVICE_NAME="dove_evb4"
        fi
        
        # Â∞ùËØï‰∏çÂêåÁöÑËæìÂá∫Ë∑ØÂæÑ
        OUTPUT_PATHS=(
          "out/target/product/$DEVICE_NAME"
          "out/target/product/twrp_$DEVICE_NAME"
          "out/target/product/omni_$DEVICE_NAME"
        )
        
        OUTPUT_DIR=""
        for path in "${OUTPUT_PATHS[@]}"; do
          if [ -d "$path" ]; then
            OUTPUT_DIR="$path"
            echo "‚úÖ ÊâæÂà∞ËæìÂá∫ÁõÆÂΩï: $OUTPUT_DIR"
            break
          fi
        done
        
        if [ -z "$OUTPUT_DIR" ]; then
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ê†áÂáÜËæìÂá∫ÁõÆÂΩïÔºåÂ∞ùËØïÊü•ÊâæÁ¨¨‰∏Ä‰∏™Â≠òÂú®ÁöÑÁõÆÂΩï..."
          OUTPUT_DIR=$(find out/target/product -type d -name "*" | head -1)
          if [ -n "$OUTPUT_DIR" ]; then
            echo "‰ΩøÁî®ÁõÆÂΩï: $OUTPUT_DIR"
          else
            echo "‚ùå Êú™ÊâæÂà∞‰ªª‰ΩïËæìÂá∫ÁõÆÂΩï"
            echo "outÁõÆÂΩïÁªìÊûÑ:"
            find out -type d 2>/dev/null | head -30
            exit 1
          fi
        fi
        
        echo "ËæìÂá∫ÁõÆÂΩï: $OUTPUT_DIR"
        echo "Êñá‰ª∂ÂàóË°®:"
        ls -la "$OUTPUT_DIR/"
        
        # Êü•ÊâæÁâπÂÆöÊñá‰ª∂
        echo "Êü•ÊâæÈïúÂÉèÊñá‰ª∂:"
        find "$OUTPUT_DIR" -name "*.img" -o -name "*.zip" -o -name "*.bin" | sort
        
        # Ê£ÄÊü•‰∏ªË¶ÅËæìÂá∫Êñá‰ª∂
        BUILD_TARGET="${{ github.event.inputs.BUILD_TARGET }}"
        
        # Â∞ùËØï‰∏çÂêåÁöÑÊñá‰ª∂ÂêçÊ®°Âºè
        TARGET_FILES=(
          "$OUTPUT_DIR/$BUILD_TARGET.img"
          "$OUTPUT_DIR/recovery.img"
          "$OUTPUT_DIR/boot.img"
          "$OUTPUT_DIR/twrp_$DEVICE_NAME.img"
          "$OUTPUT_DIR/omni_$DEVICE_NAME.img"
        )
        
        FOUND_FILE=""
        for file in "${TARGET_FILES[@]}"; do
          if [ -f "$file" ]; then
            FOUND_FILE="$file"
            echo "‚úÖ ÊâæÂà∞ÁõÆÊ†áÊñá‰ª∂: $FOUND_FILE"
            echo "Êñá‰ª∂Â§ßÂ∞è: $(du -h "$FOUND_FILE" | cut -f1)"
            break
          fi
        done
        
        if [ -z "$FOUND_FILE" ]; then
          echo "‚ö†Ô∏è Êú™ÊâæÂà∞Ê†áÂáÜÁõÆÊ†áÊñá‰ª∂ÔºåÂàóÂá∫ÊâÄÊúâ.imgÊñá‰ª∂:"
          find "$OUTPUT_DIR" -name "*.img" -exec du -h {} \;
          
          # Ëé∑ÂèñÁ¨¨‰∏Ä‰∏™.imgÊñá‰ª∂
          FIRST_IMG=$(find "$OUTPUT_DIR" -name "*.img" | head -1)
          if [ -n "$FIRST_IMG" ]; then
            FOUND_FILE="$FIRST_IMG"
            echo "‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊâæÂà∞ÁöÑ.imgÊñá‰ª∂: $FOUND_FILE"
          fi
        fi
        
        # ‰øùÂ≠òÊâæÂà∞ÁöÑÊñá‰ª∂Ë∑ØÂæÑÂà∞ÁéØÂ¢ÉÂèòÈáè
        if [ -n "$FOUND_FILE" ]; then
          echo "FOUND_FILE=$FOUND_FILE" >> $GITHUB_ENV
          echo "OUTPUT_DIR=$OUTPUT_DIR" >> $GITHUB_ENV
          
          # Ëé∑ÂèñÊâÄÊúâË¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂
          ALL_FILES=$(find "$OUTPUT_DIR" -name "*.img" -o -name "*.zip" -o -name "*.bin" | tr '\n' ' ')
          echo "ALL_FILES=$ALL_FILES" >> $GITHUB_ENV
          
          echo "ÊâÄÊúâÊâæÂà∞ÁöÑÊñá‰ª∂:"
          echo "$ALL_FILES"
        fi

    - name: Auto Create Release
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' && env.FOUND_FILE != '' }}
      id: create_release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ env.FOUND_FILE }}
          ${{ env.OUTPUT_DIR }}/*.zip
          ${{ env.OUTPUT_DIR }}/*vendor*.img
          ${{ env.OUTPUT_DIR }}/*.bin
        name: TWRP-${{ env.DEVICE_NAME }}-${{ github.run_number }}
        tag_name: v${{ github.run_number }}
        body: |
          # TWRP Build Results
          
          ## Build Information
          - **Build ID**: ${{ github.run_number }}
          - **Device**: ${{ env.DEVICE_NAME }}
          - **Target**: ${{ github.event.inputs.BUILD_TARGET }}
          - **Manifest**: ${{ github.event.inputs.MANIFEST_BRANCH }}
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Device Information
          - **Device Tree Source**: ${{ github.event.inputs.DEVICE_TREE_SOURCE }}
          ${{ github.event.inputs.DEVICE_TREE_URL && format('- **Device Tree**: {0}', github.event.inputs.DEVICE_TREE_URL) || '' }}
          ${{ github.event.inputs.DEVICE_PATH && format('- **Device Path**: {0}', github.event.inputs.DEVICE_PATH) || '' }}
          
          ## Build Files
          $(echo "‰ª•‰∏ãÊñá‰ª∂Â∑≤ÂåÖÂê´Âú®Ê≠§Release‰∏≠:" && for file in ${{ env.ALL_FILES }}; do echo "- \`$(basename "$file")\`"; done)
          
          ## Installation Instructions
          1. Download the appropriate recovery/boot image for your device
          2. Reboot to bootloader/fastboot mode
          3. Flash using: `fastboot flash ${{ github.event.inputs.BUILD_TARGET }} <filename>.img`
          4. Reboot to recovery: `fastboot reboot recovery`
          
          ## Notes
          - This is an automated build from GitHub Actions
          - Flash at your own risk
          - Always backup your data before flashing
          - Report issues in the repository's Issues section
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Auto Upload to Release (Fallback)
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' && env.FOUND_FILE == '' }}
      uses: softprops/action-gh-release@v2
      with:
        files: |
          workspace/out/target/product/*/*.img
          workspace/out/target/product/*/*.zip
          workspace/out/target/product/*/*.bin
        name: TWRP-${{ env.DEVICE_NAME }}-${{ github.run_number }}-fallback
        tag_name: v${{ github.run_number }}-fallback
        body: |
          # TWRP Build Results (Fallback)
          
          ## Build Information
          - **Build ID**: ${{ github.run_number }}
          - **Device**: ${{ env.DEVICE_NAME }}
          - **Status**: Fallback mode - files found via wildcard search
          - **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          
          ## Notes
          - This release was created in fallback mode
          - The build may have generated files in non-standard locations
          - Please verify the files before flashing
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts to GitHub
      if: ${{ github.event.inputs.CREATE_RELEASE != 'true' && env.FOUND_FILE != '' }}
      uses: actions/upload-artifact@v4
      with:
        name: twrp-${{ env.DEVICE_NAME }}-${{ github.run_number }}
        path: |
          ${{ env.FOUND_FILE }}
          ${{ env.OUTPUT_DIR }}/*.zip
          ${{ env.OUTPUT_DIR }}/*vendor*.img
          ${{ env.OUTPUT_DIR }}/*.bin
        retention-days: 7
      continue-on-error: true

    - name: Upload artifacts fallback
      if: ${{ github.event.inputs.CREATE_RELEASE != 'true' && env.FOUND_FILE == '' }}
      uses: actions/upload-artifact@v4
      with:
        name: twrp-${{ env.DEVICE_NAME }}-${{ github.run_number }}-fallback
        path: |
          workspace/out/target/product/*/*.img
          workspace/out/target/product/*/*.zip
          workspace/out/target/product/*/*.bin
        retention-days: 7
      continue-on-error: true

    - name: Release Summary
      if: ${{ github.event.inputs.CREATE_RELEASE == 'true' }}
      run: |
        echo "=== Release ÂàõÂª∫ÊÄªÁªì ==="
        echo "‚úÖ Release Â∑≤ÊàêÂäüÂàõÂª∫"
        echo "ËÆæÂ§á: ${{ env.DEVICE_NAME }}"
        echo "Release ÂêçÁß∞: TWRP-${{ env.DEVICE_NAME }}-${{ github.run_number }}"
        echo "Tag: v${{ github.run_number }}"
        
        if [ -n "${{ env.FOUND_FILE }}" ]; then
          echo "‰∏ªË¶ÅÊñá‰ª∂: ${{ env.FOUND_FILE }}"
          echo "Êñá‰ª∂Â§ßÂ∞è: $(du -h "${{ env.FOUND_FILE }}" 2>/dev/null | cut -f1 || echo 'Êú™Áü•')"
        fi
        
        echo "ÊâÄÊúâÊñá‰ª∂:"
        for file in ${{ env.ALL_FILES }}; do
          echo "- $(basename "$file")"
        done
        
        # ÁîüÊàêRelease URL
        REPO_NAME="${{ github.repository }}"
        echo "Release URL: https://github.com/$REPO_NAME/releases/tag/v${{ github.run_number }}"
